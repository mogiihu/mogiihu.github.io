{
    "sourceFile": "src/content/posts/2020-12-17-微信小程序保存图片到相册/index.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1756112856304,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1756112856304,
            "name": "Commit-0",
            "content": "---\ntitle: 微信小程序保存图片到相册\npublished: 2020-12-17 22:29:22\ndescription: ''\nimage: ''\ntags: [小程序, 前端, Taro]\ncategory: '小程序'\ndraft: false \nlang: ''\n---\n\n\n在开发过程中经常遇到保存图片到相册的需求，主要有两种一是保存服务器地址图片，还有一种是保存 canvas 生成的 base64 格式图片，下面来讲解分别怎么实现。\n\n## 保存服务器地址图片到相册\n\n```js\n// 查看是否有 `scope.writePhotosAlbum` 权限\nwx.getSetting({\n  success: (res) => {\n    if (!res.authSetting[\"scope.writePhotosAlbum\"]) {\n      // 申请所需权限\n      wx.authorize({\n        scope: \"scope.writePhotosAlbum\",\n        success: () => {\n          // 授权成功保存图片\n          saveToAlbum();\n        },\n        fail: () => {\n          // 授权失败\n        },\n      });\n    } else {\n      // 用户到设置中同意保存相册权限后再次保存到相册\n      saveToAlbum();\n    }\n  },\n});\n\n// 保存图片到相册\nfunction saveToAlbum() {\n  // 下载图片资源到本地\n  wx.downloadFile({\n    url: imgUrl,\n    success: function (res) {\n      // 保存图片到相册\n      wx.saveImageToPhotosAlbum({\n        filePath: res.tempFilePath,\n        success(res) {\n          // 保存成功\n        },\n        fail: () => {\n          // 保存失败\n        },\n      });\n    },\n    fail: () => {\n      // 下载失败\n    },\n  });\n}\n```\n\n## 保存 base64 格式图片到相册\n\n```js\n// 查看是否有 `scope.writePhotosAlbum` 权限\nwx.getSetting({\n  success: (res) => {\n    if (!res.authSetting[\"scope.writePhotosAlbum\"]) {\n      // 申请所需权限\n      wx.authorize({\n        scope: \"scope.writePhotosAlbum\",\n        success: () => {\n          // 授权成功保存图片\n          saveToAlbum();\n        },\n        fail: () => {\n          // 授权失败\n        },\n      });\n    } else {\n      // 用户到设置中同意保存相册权限后再次保存到相册\n      saveToAlbum();\n    }\n  },\n});\n\n// 保存图片到相册\nfunction saveToAlbum() {\n  // 把base64的图片转化成ArrayBuffer数据\n  const buffer = wx.base64ToArrayBuffer(\n    img.replace(/^data:\\w+\\/\\w+;base64,/, \"\")\n  );\n  // 指定图片的临时路径\n  const path = `${wx.env.USER_DATA_PATH}/image_name.png`;\n  // 获取小程序的文件系统\n  const fsm = wx.getFileSystemManager();\n  // 把arraybuffer数据写入到临时目录中\n  fsm.writeFile({\n    filePath: path,\n    data: params,\n    encoding: \"binary\",\n    success: () => {\n      // 把临时路径下的图片，保存至相册\n      wx.saveImageToPhotosAlbum({\n        filePath: path,\n        success: () => {\n          // 保存成功\n        },\n        fail: () => {\n          // 保存失败\n        },\n      });\n    },\n    fail: () => {\n      // 写入失败\n    },\n  });\n}\n```\n"
        }
    ]
}