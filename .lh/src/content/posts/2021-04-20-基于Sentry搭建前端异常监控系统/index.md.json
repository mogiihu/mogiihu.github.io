{
    "sourceFile": "src/content/posts/2021-04-20-基于Sentry搭建前端异常监控系统/index.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1756113077685,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1756113077685,
            "name": "Commit-0",
            "content": "---\ntitle: 基于Sentry搭建前端异常监控系统\npublished: 2021-04-20\ndescription: ''\nimage: ''\ntags: [基建, 前端]\ncategory: '基建'\ndraft: false \nlang: ''\n---\n\n\n## 背景\n\n虽然在我们的项目上线前会有很多的测试流程，但是测试流程肯定无法保证 100%覆盖所有操作场景，在用户的使用过程中仍会有一些问题暴露出来。\n但当线上用户出现问题，我们需要收到用户的一个反馈，才能去定位解决，这样会导致我们的问题解决不够及时。\n并且有些疑难杂症，我们无法复现定位，这时候我们需要得知用户的环境、操作等信息，以便于对问题进行排查。\n基于以上三点考虑，我认为在大部分项目中都需要接入一个异常监控系统，来实现收集异常、收集日志信息、及时警告、展示统计信息等功能。\n\n## 为什么选择 Sentry？\n\n- 免费\n- Sentry 可直接使用也可自行搭建\n- 兼容性强，基本不受语言限制，搭建一套系统可用于多个项目。\n  ![Sentry可适用平台](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/08056a3dbf414ba0a7ee7180952c4f96~tplv-k3u1fbpfcp-zoom-1.image)\n\n## Sentry 简介\n\n> Sentry's application monitoring platform helps every developer\n> diagnose, fix, and optimize the performance of their code.\n\nSentry 的应用程序监视平台可帮助每个开发人员诊断，修复和优化其代码的性能。\n\n## Sentry 部署及使用\n\nSentry 可直接使用也可自行搭建，下面将讲解 Sentry 的搭建过程。想要直接体验的可以跳过直接戳[官网](https://sentry.io/auth/login/)进行体验。\n\n官方提供安装方式是使用 [Docker](https://www.docker.com/) 和 [Docker Compose](https://docs.docker.com/compose/) 以及基于 bash 的安装和升级脚本。\n\n### 环境要求\n\n- Docker 19.03.6+\n- Compose 1.24.1+\n- 4 CPU Cores\n- 8 GB RAM\n- 20 GB Free Disk Space\n- Python 3\n\n这里就不对环境的配置进行详细说明，想自己搭建的同学可以参考下以下文章。\n\n- [yum 方式安装升级 docker](https://blog.csdn.net/weixin_37745913/article/details/99966937)\n- [新装的 CentOS 7 安装 python3](https://blog.csdn.net/lovefengruoqing/article/details/79284573)\n\n####\n\n### 部署步骤\n\n1. 从 github 上获取 Sentry 最新代码。\n\n```shell\ngit clone https://github.com/getsentry/onpremise.git\n```\n\n2. 进入 onpremise ，运行 install.sh 脚本。\n\n```shell\ncd onpremise\n./install.sh\n```\n\n3. 运行 `docker-compose up -d` 以启动 Sentry。\n\n按照默认配置构建后，Sentry 默认绑定 9000 端口，访问 [http://127.0.0.1:9000](http://127.0.0.1:9000) 即可进入登录页面。\n\n4. 打开页面填写信息后即可进入 Sentry 系统\n\n![初始化界面](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4489c9938d9f4f5fb82d72273f878104~tplv-k3u1fbpfcp-zoom-1.image)\n\n5. 自动发送警告邮件配置，可以从上图配置，也可以从配置文件配置，下面为通过 config.yml 配置教程。\n   打开 onpremise/sentry 下的 config.yml 文件，修改 Mail Server 配置内容。![异常警告发送邮件配置](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/59d7de2e95034ca6a3605d7f85344246~tplv-k3u1fbpfcp-zoom-1.image)\n\n- mail.backend：邮件发送方式；\n- mail.host: 邮件发送域名 ，使用的哪个邮箱可以去该邮箱文档中找到 smtp 发送域名；\n- mail.port: 邮件发送的端口号；\n- mail.username：用于 smtp 邮箱的账号；\n- mail.password：用于 smtp 邮箱的密码；\n- mail.use-tls：是否使用 tls 安全协议，这里填写 true 或 false，和 use-ssl 配置互斥；\n- mail.use-ssl：是否使用 ssl 安全协议，这里填写 true 或 false，和 use-tls 配置互斥；\n- mail.from：收到邮件时的发送人名称；\n\n6. 通过配置文件修改邮件服务后，需要运行 `docker-compose up -d`  更新 Sentry，如果更新失败则需要关闭 docker-compose 后重新运行。\n\n```shell\ndocker-compose down\ndocker-compose build\ndocker-compose up -d\n```\n\n重启后可通过 头像-> admin -> mail 进入 mail 配置页，点击发送测试邮件来检测是否配置成功。\n\n![测试邮件服务配置](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/efb59c11088a471da58ed76146b768ca~tplv-k3u1fbpfcp-zoom-1.image)\n\n## Sentry 设置通过 HTTPS 访问\n\n有没有发现上面 Sentry 的启动地址还有 DSN 地址都是 http，现在要给 Sentry 配置 ssl 让我们能通过 https 使用。\n\n首先要修改 onpremise/sentry/config.yml `system.url-prefix` 配置，将其设置为我们访问的 Sentry 域名。 `url-prefix` 组成了项目的 DSN 地址，一定要保证格式正确。\n\n```\nsystem.url-prefix: 'https://sentry.xxxxx.com:60000'\n```\n\n然后是 onpremise/sentry/sentry.conf.py 文件下的 SSL/TLS 配置，将原来注释的部分全部打开。\n![修改 SSL/TLS 配置](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6e5675d158ce44948df9c4e732aafd87~tplv-k3u1fbpfcp-zoom-1.image)\n修改完后同样要将 docker-compose 关掉重建。\n\n```shell\ndocker-compose down\ndocker-compose build\ndocker-compose up -d\n```\n\n上面的配置只是让 Sentry 允许通过 SSL 代理，下面我们需要在服务器内搭建一个 nginx 用来转发 https 协议内容，搭建的过程不多说，百度或者请教运维大大。下面是我的 nginx 配置，配好 nginx 并重启后就算大功告成。我们的 Sentry 终于可以通过 https 访问了！\n\n```nginx\nserver {\n    # 配置监听端口\n    listen       60000 ssl http2 default_server;\n    listen       [::]:60000 ssl http2 default_server;\n\n    # 域名\n    server_name  sentry.xxxxx.cn;\n\n    # nginx 默认根目录\n    root         /usr/share/nginx/html;\n\n    # 加载其他配置文件，这里是 nginx 默认配置，可以不需要\n    include /etc/nginx/default.d/*.conf;\n\n    # ssl 设置\n    ssl on;\n    # ssl 证书地址\n    ssl_certificate     /etc/nginx/sslcert/server.crt;\n    # ssl 密钥地址\n    ssl_certificate_key /etc/nginx/sslcert/server.key;\n    ssl_session_cache shared:SSL:1m;\n    ssl_session_timeout  10m;\n\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n    ssl_ciphers EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;\n    ssl_prefer_server_ciphers on;\n\n\n    client_max_body_size 200M;\n    client_body_buffer_size 1024k;\n\n    # 这一段是最重要的，将域名代理到本机 http://localhost:9000 服务上，对应的就是 docker 内的 sentry 服务\n    location / {\n        proxy_pass http://localhost:9000;\n    }\n\n    gzip  on;\n    gzip_http_version 1.1;\n    gzip_vary on;\n    gzip_comp_level 9;\n    gzip_proxied any;\n    gzip_types text/plain  text/css application/json  application/x-javascript text/xml application/xml application/xml+rss text/javascript application/x-shockwave-flash image/png image/x-icon image/gif image/jpeg;\n    gzip_buffers 16 8k;\n\n    error_page 404 /404.html;\n        location = /404.html {\n    }\n\n    error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n    }\n}\n```\n\n## Sentry 接入实例\n\n通过上面的过程 Sentry 系统就搭建好了，访问配置的地址即可进入 Sentry 系统。没有搭建的朋友们，也可以直接通过[官网](https://sentry.io/auth/login/)体验下面接入项目的过程。\n\n### 创建项目\n\n进入系统后点右上角的 `New Project`  创建项目。\n\n![Sentry 创建项目](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/010301c5088049d1b322932ce42439a7~tplv-k3u1fbpfcp-zoom-1.image)\n\n这里以 React 项目为例，建立一个 React 项目，按照页面提示即可在项目中注册 Sentry，对系项目执行中出现的异常进行捕捉。\n\n![Sentry接入项目及初始化](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9ad44d8621ba467c8d0da3b6d1a6371e~tplv-k3u1fbpfcp-zoom-1.image)\n\n### 配置\n\nSentry 配置应在应用程序的生命周期中尽早进行。完成此操作后，Sentry 的 JavaScript SDK 会捕获所有未处理的异常和事务。init 参数详解：\n\n```javascript\nSentry.init({\n  // Sentry 项目的 dsn，可从项目设置中获取\n  dsn: \"https://xxxxxx@161.xxx.xxx.xxx:9000/2\",\n  // 初始参数配置内容\n  integrations: [new Integrations.BrowserTracing()],\n  // 触发异常后发送给 Sentry 的概率\n  tracesSampleRate: 1.0,\n  // 控制应捕获的面包屑(行为栈)的总量\n  maxBreadcrumbs: 20,\n  // 规定上下文数据结构的深度，默认为 3\n  normalizeDepth: 100,\n  // 版本信息\n  release: \"common@1.0.0\",\n  // 环境信息\n  environment: process.env.NODE_ENV,\n  // 钩子函数，在每次发送 event 前触发\n  beforeSend(event) {\n    // 网页应用刷新后设置的变量会消失，所以我选择在 beforeSend 触发时插入用户信息\n    event.user = {\n      userNick: \"xiaohu\",\n    };\n    return event;\n  },\n});\n```\n\n### 设置变量\n\n在 Sentry 中，可以使用 `set` + `tags`，`extra`，`contexts`，`user`，`level`，`fingerprint` 形式，设置变量。下面将简单介绍几种方式，详情使用方法可见[文档](https://docs.sentry.io/platforms/javascript/enriching-events/context/#clearing-context)。\n\n#### 通过 setUser 设置全局变量用户信息示例（不建议使用）\n\n捕捉异常还需要采集用户信息，在用户登录后需要通过 `setUser` 设置一下用户信息全局变量，如下所示。**注意，通过这种方式设置的全局变量在页面刷新后会消失。**设置用户信息代码：\n\n```javascript\nSentry.setUser({\n  tenant: {\n    code: 12345,\n    name: \"测试公司\",\n    _id: 12345,\n  },\n  orgAccount: {\n    _id: 54321,\n    orgName: \"是机构啦\",\n  },\n  user: {\n    _id: \"8910JQ\",\n    loginName: \"测试人员小Q\",\n  },\n});\n```\n\n设置全局变量后触发的 issue 中，可看到上传的用户数据。\n\n![自定义 user 数据展示](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/787674fe40cb458fb4f2be0165046ab5~tplv-k3u1fbpfcp-zoom-1.image)\n\n#### 通过 beforeSnd 插入用户信息\n\n通过 Sentry 机制设置的全局变量在页面刷新后会消失，这边我建议通过 `beforeSend`  函数，修改 event 中的数据来插入需要的全局变量。\n\n```javascript\nSentry.init({\n    ...,\n \t  // 钩子函数，在每次发送 event 前触发\n    beforeSend(event) {\n        // 在这里可根据业务情况发送用户信息\n        event.user = {\n            userNick: 'xiaohu'\n        };\n        return event;\n    }\n});\n```\n\n####\n\n#### 设置全局变量\n\n```javascript\n// 以下是 Sentry 定义的全局变量，可以直接使用 Sentry api 设置\nSentry.setUser(object);\nSentry.tags(object);\nSentry.extra(object);\nSentry.level(object);\nSentry.fingerprint(object);\n\n// 通过 setContext，设置 key 值，可自定义随事件传递的变量名\nSentry.setContext(key, context);\n```\n\n#### 设置局部变量\n\n`captureException` 是我常用的一种设置局部变量并上传报错的方式，`Sentry.captureException(err[, obj])` 第一个参数为抛出的异常，第二个参数可附加错误信息。\n第二个参数为对象，key 值可为 `tags`，`extra`，`contexts`，`user`，`level`，`fingerprint` 这 6 种。\n\n```javascript\nSentry.captureException(error, {\n  contexts: {\n    message: {\n      a: 1,\n      b: { b: 1 },\n    },\n  },\n});\n```\n\n#### 设置局部变量网络报错信息示例\n\n根据目前前端框架所用的 axios，对网络请求出错的局部数据进行收集，代码示例：\n\n```javascript\nSentry.captureException(error, {\n  contexts: {\n    message: {\n      url: error.response.config.baseURL + error.response.config.url,\n      data: error.response.config.data,\n      method: error.response.config.method,\n      status: error.response.status,\n      statusText: error.response.statusText,\n      responseData: JSON.stringify(error.response.data),\n    },\n  },\n});\n```\n\n#### 清除全局变量\n\n在用户退出登录后需要清除该用户的用户信息，有以下两种方式。\n\n1. 通过设置为空，可以清除设置过的数据。\n\n```javascript\nSentry.setUser();\n```\n\n2. 通过 `scope.clear()`  清除全局变量。\n\n```javascript\nSentry.configureScope((scope) => scope.clear()); // 清除所有全局变量\nSentry.configureScope((scope) => scope.setUser(null)); // 清除 user 变量\n```\n\n### 上传日志信息\n\n有时我们不仅仅要收集异常信息，还需要在页面中打 log 来收集页面运行数据，这时可以用 `Sentry.captureMessage(err[, obj])` api，进行传输日志。使用方法与 `captureException` 一致，建议将 level 设置为 Info，便于与异常区分开来，避免触发我们设置的异常警报。\n\n```javascript\nSentry.captureMessage(\"Something went fundamentally wrong\", {\n  contexts: {\n    text: {\n      hahah: 22,\n    },\n  },\n  level: Sentry.Severity.Info,\n});\n```\n\n### 上传 sourceMap\n\nSentry 可将前端项目打包后的 SourceMap 上传，方便我们查看异常所在的代码位置。\n[Sentry 集成 sourcemap](https://blog.csdn.net/weixin_34996214/article/details/112278553)\n\n### 卸载 sentry\n\n需要卸载可参考以下链接。\n[如何卸载 Sentry？](https://segmentfault.com/q/1010000038449410)\n\n## 触发一个异常看看\n\n```js\nonClick={() => {\n\tlet a = {};\n\tconsole.log(a.b.c);\n}}\n```\n\n在这里我制造了一个异常代码，点击后大家可想而知会出现一个 js error，如下图。\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/85ffec26dd974294a9bdde11c52f0856~tplv-k3u1fbpfcp-zoom-1.image)\n\n在 network 中我们可以看到一条请求，Sentry 就是通过这样的方式上传错误的。\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/97a4b5ce5d7842de860ab4bf2778f2d5~tplv-k3u1fbpfcp-zoom-1.image)\n\n然后转到 Sentry 系统页面上，可以看到 Issues 面板中多了一条信息：\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ebee098df308415e99d6933c69b0931b~tplv-k3u1fbpfcp-zoom-1.image)\n\n点击进入后可以看到关于这条异常的详细信息。\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/42825f5c56b54ed399e71d65bd059301~tplv-k3u1fbpfcp-zoom-1.image)\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f3efa7587b00492c9e8ada110b3ab9cb~tplv-k3u1fbpfcp-zoom-1.image)\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adde805d5ee64905ab42debfe541ada6~tplv-k3u1fbpfcp-zoom-1.image)\n\n可以看到，详情里收集了大量的异常相关数据，如设备、浏览器版本、ip 地址、error 数据、用户操作栈等数据。但光有这些数据是不够的，原始的上传信息有时也不足以分析问题，很多时候我们需要根据业务场景定制所采集的数据。下面我们将从捕捉场景和采集内容这两方面进行分析。\n\n## 异常信息捕捉场景及采集内容\n\n### 捕捉场景\n\n针对前端常见业务场景，总结了以下几个场景需要收集业务报错信息。\n\n1. 接口错误\n2. 网络错误\n3. js error 报错\n4. 主要业务流程异常状态\n5. iframe/webview 内部错误\n\n以上异常如果触发了 js error 或者 Promise.reject 并且没有被抛出，会被 Sentry 自动捕捉到，如果没有自动触发可手动 new Error 或 Promise.reject(error) 抛出异常，即可被 Sentry 收集。或者使用 captureMessage Api 收集运行日志。\n\n### 采集内容\n\n尽管 Sentry SDK 会捕获所有未处理的异常和事务汇报至系统上，并且会记录产生异常的页面及设备信息。但是有这些信息是远远不够的，还需要额外的业务信息，用于更好的区别定位问题。下面是我对上报异常所需要收集的内容进行总结。\n\n异常信息：抛出异常的 error 信息，Sentry 会自动捕捉。\n\n用户信息：用户的信息（登录名、id、level 等），所属机构信息，所属公司信息。\n\n行为信息：用户的操作过程，例如登陆后进入 xx 页面，点击 xx 按钮，Sentry 会自动捕捉。\n\n版本信息：运行项目的版本信息（测试、生产、灰度），以及版本号。\n\n设备信息：项目使用的平台，web 项目包括运行设备信息及浏览器版本信息。小程序项目包括运行手机的手机型号、系统版本及微信版本。\n\n时间戳：记录异常发生时间，Sentry 会自动捕捉。\n\n异常等级：根据 Sentry 文档分为以下几个等级。\n\n- Critical\n- Debug\n- Error\n- Fatal\n- Info\n- Log\n- Warning\n\n平台信息：记录异常发生的项目。\n\n有以上内容的补全，再加上原有的异常数据，对于一个报错是不是就更清晰明了了呢。\n\n## 小程序接入 Sentry\n\nSentry 无官方 api 用于提供给小程序，好在有第三方根据提供的库，可使用原有 api 实现小程序端的异常监控。\n\n### 安装\n\n- npm install sentry-mina --save\n- yarn add sentry-mina\n- 将 browser/sentry-mina.js 拷贝到项目中\n\n### 使用\n\n```javascript\nimport * as Sentry from \"sentry-mina/browser/sentry-mina.js\";\n// import * as Sentry from \"sentry-mina\";\n// config Sentry\nSentry.init({\n  dsn: \"\",\n});\n// Set user information, as well as tags and further extras\nSentry.configureScope((scope) => {\n  scope.setUser({ id: \"4711\" });\n  scope.setTag(\"user_mode\", \"admin\");\n  scope.setExtra(\"battery\", 0.7);\n  // scope.clear();\n});\n// Add a breadcrumb for future events\nSentry.addBreadcrumb({\n  message: \"My Breadcrumb\",\n  // ...\n});\n// Capture exceptions, messages or manual events\nSentry.captureMessage(\"Hello, world!\");\nSentry.captureException(new Error(\"Good bye\"));\nSentry.captureEvent({\n  message: \"Manual\",\n  stacktrace: [\n    // ...\n  ],\n});\n```\n\n其他内容见文档 [Sentry 小程序 SDK](https://developers.weixin.qq.com/community/develop/doc/000cecefb009a0a951c727d6c55406)。\n\n## 问题总结\n\n下面是我在接入 Sentry 及后续使用时遇到的问题。\n\n### consolelog 不显示 sourmap 地址\n\n![consolelog 不显示 sourmap 地址](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3dbbbba40de1411f96a4fa0d629ff2e1~tplv-k3u1fbpfcp-zoom-1.image)\n\n这个问题产生的原因是，Sentry 会修改原生 console 方法收集 console，所以这边不会显示 sourcemap 地址，可以在开发环境下取消注册 Sentry。\n\n## 结尾\n\n以上所述就是作者给大家介绍的基于 Sentry 搭建前端异常监控系统的过程，希望对大家有所帮助，如果大家有任何疑问请给我留言，我会及时回复大家的！\n"
        }
    ]
}